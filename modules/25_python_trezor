python_trezor_version="0.11.3"

python_trezor_s1(){ 
  # Horrible hack to get past the buggy postinit script in udev, required by libudev-dev
  mkdir $assets/hidapi
  pushd $assets/hidapi
  wget http://http.us.debian.org/debian/pool/main/s/systemd/libudev1_241-5~bpo9+1_amd64.deb
  wget http://http.us.debian.org/debian/pool/main/s/systemd/udev_241-5~bpo9+1_amd64.deb
  wget http://http.us.debian.org/debian/pool/main/s/systemd/libudev-dev_241-5~bpo9+1_amd64.deb  
  popd
}

python_trezor_s2(){
  # Install packages needed for python / pip
  $apt_update ; apt_update="true"
  
  # Horrible hack to get past the buggy postinit script in udev, required by libudev-dev
  pushd $assets/hidapi
  dpkg --unpack *.deb
  rm -f /var/lib/dpkg/info/udev.postinst 
  dpkg --configure libudev1
  dpkg --configure udev
  dpkg --configure libudev-dev
  apt-get install -yf
  popd

  apt-get install -y --no-upgrade python3-dev python3-pip cython3 libusb-1.0-0-dev build-essential python3-wheel
}

python_trezor_s3(){
  # export msg="DBG: INSTALLING PYTHON / PIP"; zenity --info --text="$msg" 1> /dev/null 2>&1
  # user_third_stage
  until pip3 install --user --upgrade setuptools
  do
    export msg="PIP often fails on network IO when in Tails.  Would you like to retry?"
    zenity --question --text="$msg" 1> /dev/null 2>&1
  done
  
  until pip3 install --user --upgrade trezor[ethereum,hidapi]==$python_trezor_version
  do
    export msg="PIP often fails on network IO when in Tails.  Would you like to retry?"
    zenity --question --text="$msg" 1> /dev/null 2>&1
  done

  # export msg="DBG: FINALIZING PYTHON"; zenity --info --text="$msg" 1> /dev/null 2>&1
  # move python /pip stuff over
  rsync -a ~amnesia/.local/bin/ $persist/local/bin/
  rsync -a ~amnesia/.local/lib/ $persist/local/lib/
}